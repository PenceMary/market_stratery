# 📊 历史量能分析功能说明

## 🎯 功能概述

新增历史分时数据获取和量能分析功能，可以分析最近若干天的每日每小时量能分布（U:D:E量能比），帮助判断资金流向趋势和主力行为模式。

## 🆕 新增功能

### 1. 历史分时数据获取（带缓存）

**功能描述：**
- 自动获取最近N天的分时数据（N由配置文件控制）
- 智能缓存机制：优先从本地 `data_output/` 文件夹加载
- 数据完整性检查：自动验证缓存数据是否包含完整交易时段
- 自动重试：网络失败时自动重试，提高成功率

**实现位置：**
- `intraday_data_fetcher.py` 中的 `get_historical_intraday_with_cache()` 方法

**缓存机制：**
```
data_output/
└── 股票代码/
    ├── 股票代码_20251021_intraday.csv
    ├── 股票代码_20251022_intraday.csv
    └── 股票代码_20251023_intraday.csv
```

### 2. 量能分布计算

**功能描述：**
- 按每天、每小时统计U（上涨）、D（下跌）、E（平盘）量能
- 计算各时段的U/D比，判断多空力量对比
- 统计成交量占比，识别重点交易时段

**量能类型说明：**
- **U（Up）量能**：价格上涨时的成交量×价格
- **D（Down）量能**：价格下跌时的成交量×价格
- **E（Equal）量能**：价格不变时的成交量×价格

**时段划分：**
```
09:25          - 集合竞价
09:30-10:30    - 早盘第一小时
10:30-11:30    - 早盘第二小时
13:00-14:00    - 午盘
14:00-15:00    - 尾盘
全天            - 汇总（排除09:25）
```

**实现位置：**
- `intraday_data_fetcher.py` 中的 `calculate_hourly_volume()` 方法

### 3. 提示词集成

**功能描述：**
- 自动将量能数据格式化为表格
- 按日期排序展示多日量能对比
- 在提示词中明确要求大模型分析量能趋势

**输出格式示例：**
```markdown
#### 🗓 2025年10月21日（星期一）

| 时间段 | U占比 | D占比 | E占比 | U/D比 | 成交量占比 |
|--------|-------|-------|-------|-------|------------|
| 09:25 | 100.00% | 0.00% | 0.00% | NA | 0.0023 |
| 09:30-10:30 | 51.07% | 48.59% | 0.33% | 1.05 | 0.3616 |
| 10:30-11:30 | 34.80% | 65.17% | 0.03% | 0.53 | 0.1816 |
| 13:00-14:00 | 55.52% | 44.43% | 0.05% | 1.25 | 0.2501 |
| 14:00-15:00 | 44.38% | 55.62% | 0.00% | 0.80 | 0.2044 |
| **全天** | **47.86%** | **52.00%** | **0.14%** | **0.92** | **0.9977** |
```

**实现位置：**
- `intraday_prompt_builder.py` 中的 `_build_hourly_volume()` 方法

## ⚙️ 配置说明

在 `intraday_trading_config.json` 中配置：

```json
{
  "data_config": {
    "history_days": 3    // 获取最近3天的历史分时数据
  }
}
```

**推荐配置：**
- `history_days: 3` - 分析短期资金流向（适合日内交易）
- `history_days: 5` - 分析中期资金流向（适合波段交易）
- `history_days: 10` - 分析长期资金流向（适合趋势跟踪）

**注意：**
- 天数越多，数据获取时间越长
- 建议不超过10天，避免提示词过长

## 📈 使用流程

### 自动流程（无需手动操作）

```
1. 运行分析 → 2. 检查缓存 → 3. 获取数据 → 4. 计算量能 → 5. 发送给大模型
```

### 详细步骤：

**步骤1：检查本地缓存**
```
data_output/000100/ 文件夹
  ├── 已存在且完整 → 直接加载 ✅
  └── 不存在或不完整 → 删除重新获取 🔄
```

**步骤2：获取历史数据**
```python
# 自动执行（配置了history_days > 0）
历史分时数据 = 获取最近N天的分时数据
  → 每天检查缓存
  → 缺失则从接口获取
  → 保存到data_output/
```

**步骤3：计算量能分布**
```python
量能统计 = 分析每天每小时的U/D/E量能
  → 计算各时段占比
  → 计算U/D比
  → 统计成交量占比
```

**步骤4：发送给大模型**
```
提示词包含：
  - 实时行情
  - 技术指标
  - 📊 历史量能分析（新增）
  - 大盘状态
  - 板块联动
```

## 💡 量能数据解读

### U/D比指标含义

| U/D比 | 含义 | 市场状态 |
|-------|------|----------|
| > 1.5 | 多方力量强势 | 强势上涨 |
| 1.0 - 1.5 | 多方占优 | 温和上涨 |
| 0.8 - 1.0 | 多空均衡 | 震荡整理 |
| 0.5 - 0.8 | 空方占优 | 温和下跌 |
| < 0.5 | 空方力量强势 | 强势下跌 |

### 时段特征分析

**早盘第一小时（09:30-10:30）**
- 成交量占比通常最大（30-40%）
- 资金活跃度最高
- 重点观察：如果U/D比>1.2，通常预示全天强势

**午盘（13:00-14:00）**
- 成交量占比次之（20-30%）
- 方向延续性强
- 重点观察：与早盘方向是否一致

**尾盘（14:00-15:00）**
- 成交量占比较小（15-25%）
- 尾盘拉升/跳水信号
- 重点观察：U/D比突变可能预示次日走势

### 多日趋势分析

**连续多日U/D比 > 1.0**
→ 资金持续流入，趋势向上，可考虑做多

**连续多日U/D比 < 1.0**
→ 资金持续流出，趋势向下，应谨慎或做空

**U/D比反转**
→ 资金流向改变，可能出现拐点，需警惕

## 🔍 实际应用示例

### 示例1：识别资金持续流入

```
10月21日：U/D比 = 1.15 （多方占优）
10月22日：U/D比 = 1.32 （多方增强）
10月23日：U/D比 = 1.48 （多方强势）
```

**分析结论：**
- 资金连续3天流入
- 多方力量逐日增强
- 趋势向上确认
- **建议：做多，轻仓试探 → 加仓跟进**

### 示例2：识别资金流向反转

```
10月21日：U/D比 = 0.65 （空方占优）
10月22日：U/D比 = 0.85 （多空接近）
10月23日：U/D比 = 1.15 （多方占优）
```

**分析结论：**
- 资金从流出转向流入
- 空方力量减弱，多方接管
- 可能出现趋势反转
- **建议：观望 → 确认后做多**

### 示例3：识别分时特征

```
某日量能分布：
09:30-10:30：U/D = 1.45（早盘多方强势）
10:30-11:30：U/D = 0.72（回调整理）
13:00-14:00：U/D = 1.28（午盘延续）
14:00-15:00：U/D = 1.52（尾盘拉升）
```

**分析结论：**
- 早盘强势，午后延续
- 全天多头格局明确
- 尾盘放量拉升，预示次日可能高开
- **建议：持有多单，次日观察高开后走势**

## 🎓 大模型分析要点

提示词中要求大模型从以下角度分析量能数据：

1. **历史量能变化趋势**
   - 观察U/D比的变化
   - 判断多空力量对比的演变

2. **时段特征**
   - 分析不同交易时段的量能特点
   - 识别早盘、午盘、尾盘的资金行为

3. **量能一致性**
   - 多日量能方向是否一致
   - 是否存在资金持续流入或流出

4. **与价格走势的配合**
   - 量能方向与价格走势是否一致
   - 是否存在量价背离

## 📁 文件修改清单

### 新增方法

**`intraday_data_fetcher.py`:**
- `_get_stock_output_dir()` - 获取输出目录
- `_get_intraday_cache_path()` - 获取缓存路径
- `_check_intraday_data_completeness()` - 检查数据完整性
- `_get_trading_dates()` - 获取交易日列表
- `get_historical_intraday_with_cache()` - 获取历史分时数据（带缓存）
- `calculate_hourly_volume()` - 计算量能分布

**`intraday_prompt_builder.py`:**
- `_build_hourly_volume()` - 格式化量能数据

### 修改文件

**`intraday_trading_main.py`:**
- 在 `_fetch_all_data()` 方法中添加历史分时数据获取和量能计算

**`a_stock_trading_prompt_template.txt`:**
- 添加量能分析数据展示示例
- 更新分析要求，强调量能趋势分析

## ⚡ 性能优化

### 缓存机制

**首次运行：**
```
获取3天数据：约15-30秒
  → 每天5-10秒（网络请求）
```

**后续运行（有缓存）：**
```
获取3天数据：约1-2秒
  → 直接从本地加载
  → 仅获取新增日期
```

### 数据验证

自动检查缓存数据是否包含完整交易时段（9、10、11、13、14、15点），确保数据质量。

## 🔧 故障排除

### 问题1：数据获取失败

**症状：** 历史分时数据获取失败

**可能原因：**
- 网络连接问题
- 非交易日或节假日
- 股票代码错误

**解决方法：**
- 检查网络连接
- 确认是否在交易日运行
- 系统会自动重试3次

### 问题2：缓存数据不完整

**症状：** 提示数据不完整，重新获取

**原因：**
- 之前获取的数据缺少某些小时的数据
- 文件损坏

**解决方法：**
- 系统会自动删除不完整的缓存
- 重新从接口获取完整数据
- 无需手动干预

### 问题3：提示词过长

**症状：** 大模型提示超出限制

**解决方法：**
- 减少 `history_days` 配置值
- 建议设置为3-5天

## ✅ 测试建议

### 测试1：缓存功能测试

```bash
# 第一次运行（获取数据）
python intraday_trading_main.py 600000

# 第二次运行（使用缓存）
python intraday_trading_main.py 600000

# 观察：第二次应该更快，提示"从缓存加载"
```

### 测试2：数据完整性测试

```bash
# 手动删除某个日期的数据文件
rm data_output/600000/600000_20251023_intraday.csv

# 再次运行
python intraday_trading_main.py 600000

# 观察：系统应该自动重新获取缺失的数据
```

### 测试3：量能分析测试

```bash
# 运行分析并查看输出目录
python intraday_trading_main.py 600000

# 查看生成的prompt文件
cat intraday_output/600000_*_prompt_*.txt

# 确认包含"历史量能分析"部分
```

## 📊 输出示例

查看实际生成的提示词文件：
```
intraday_output/
└── 600000_浦发银行_prompt_20251024_143022.txt
```

文件中会包含类似以下内容：
```
【历史量能分析（U:D:E量能比）】

说明：U=上涨量能，D=下跌量能，E=平盘量能...

#### 🗓 2025年10月21日（星期一）
[量能数据表格]

#### 🗓 2025年10月22日（星期二）
[量能数据表格]

#### 🗓 2025年10月23日（星期三）
[量能数据表格]
```

---

**版本**: v1.0  
**更新时间**: 2025-10-24  
**状态**: ✅ 已实施并集成

