# 邮件发送功能说明

## 功能概述

日内交易分析系统现已支持自动HTML转换和邮件发送功能。分析完成后，系统会：

1. **保存Markdown报告**：原始的分析报告（.md格式）
2. **转换为HTML**：自动将Markdown转换为美观的HTML格式
3. **自动发送邮件**：将报告作为附件发送到指定邮箱

## 配置说明

### 邮件配置（keys.json）

在 `keys.json` 文件中需要配置以下邮件相关参数：

```json
{
    "qwen_api_key": "你的通义千问API密钥",
    "deepseek_api_key": "你的DeepSeek API密钥",
    "email_sender": "发件人邮箱@163.com",
    "email_password": "邮箱授权码",
    "email_receivers": [
        "收件人1@example.com",
        "收件人2@example.com"
    ]
}
```

**重要提示**：
- `email_password` 是邮箱的**授权码**，不是邮箱登录密码
- 目前仅支持163邮箱作为发件人（SMTP服务器配置为 `applesmtp.163.com`）
- 收件人可以配置多个邮箱地址

### 如何获取163邮箱授权码

1. 登录163邮箱
2. 进入"设置" → "POP3/SMTP/IMAP"
3. 开启"SMTP服务"
4. 点击"生成授权码"
5. 将生成的授权码填入 `email_password` 字段

## 邮件内容

### 邮件主题
系统会自动从分析报告中提取投资评级，并包含在邮件主题中：

- 如果提取到评级：`股票 {股票名称}({代码}) 日内分析 - {投资评级}`
- 如果未找到评级：`股票 {股票名称}({代码}) 日内分析报告`

### 邮件正文
邮件正文包含以下关键信息：
- 分析时间
- 当前价格
- 涨跌幅

### 邮件附件
- **HTML格式报告**：美观的网页格式，可直接在浏览器中查看
- **Markdown格式报告**：原始的分析报告文本

## 使用示例

```bash
# 分析单只股票（会自动发送邮件）
python intraday_trading_main.py 002517

# 分析多只股票（每只股票都会发送独立的邮件）
python intraday_trading_main.py 600000 000001 002517
```

## 功能细节

### 自动HTML转换
- 使用 `md_to_html.py` 模块进行转换
- 自动添加美观的CSS样式
- 支持表格、代码块、列表等Markdown特性
- 转换失败不影响邮件发送（仍会发送Markdown附件）

### 投资评级提取
系统会自动从Markdown报告中提取投资评级信息：
- 查找格式：`**投资评级** | ✅ **强烈推荐（Strong Buy）** |`
- 清理格式符号（粗体标记、表情符号等）
- 提取纯文本评级用于邮件主题

### 邮件发送日志
系统会输出详细的邮件发送日志：
```
📧 准备发送邮件...
  ✅ 已添加附件: 002517_恺英网络_analysis_20251025_210500.html
  ✅ 已添加附件: 002517_恺英网络_analysis_20251025_210500.md
  ✅ 邮件发送成功！
```

### 容错处理
- 邮件配置不完整：跳过邮件发送，仅保存本地文件
- HTML转换失败：仍会发送Markdown附件
- 邮件发送失败：保留本地文件，不影响分析流程

## 目录结构

生成的文件都保存在 `intraday_output` 目录下：

```
intraday_output/
├── 002517_恺英网络_result_20251025_210500.json     # JSON格式结果
├── 002517_恺英网络_analysis_20251025_210500.md     # Markdown报告
├── 002517_恺英网络_analysis_20251025_210500.html   # HTML报告
└── 002517_恺英网络_prompt_20251025_210500.txt      # 提示词（可选）
```

## 注意事项

1. **网络连接**：发送邮件需要稳定的网络连接
2. **SMTP限制**：163邮箱有发送频率限制，避免短时间内发送过多邮件
3. **附件大小**：单个邮件附件不宜过大（通常<10MB）
4. **授权码保密**：请妥善保管邮箱授权码，不要泄露给他人
5. **垃圾邮件**：首次发送可能被标记为垃圾邮件，请在邮箱中标记为"非垃圾邮件"

## 禁用邮件发送

如果不需要邮件发送功能，可以：

1. **方法1**：不配置邮件参数，系统会自动跳过邮件发送
2. **方法2**：在 `keys.json` 中将邮件配置设为空：
   ```json
   {
       "email_sender": "",
       "email_password": "",
       "email_receivers": []
   }
   ```

## 故障排查

### 邮件发送失败
1. 检查邮箱授权码是否正确
2. 确认已开启163邮箱的SMTP服务
3. 检查网络连接是否正常
4. 查看是否达到发送频率限制

### HTML转换失败
1. 检查 `md_to_html.py` 模块是否存在
2. 确认已安装 `markdown` 库：`pip install markdown`
3. 查看终端输出的详细错误信息

### 未收到邮件
1. 检查收件箱的垃圾邮件文件夹
2. 确认收件人邮箱地址配置正确
3. 查看终端是否显示"邮件发送成功"

## 更新日志

**v1.0 (2025-10-25)**
- ✅ 新增HTML自动转换功能
- ✅ 新增邮件自动发送功能
- ✅ 支持投资评级自动提取
- ✅ 支持多附件发送（HTML + Markdown）
- ✅ 完善的错误处理和日志输出

