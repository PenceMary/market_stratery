# 邮件主题增强功能说明

## 🎯 功能概述

在邮件主题中自动包含以下关键信息，让你一眼就能看到分析结论：

1. **模型名称**：当前使用的AI模型（如 `qwen3-max`、`deepseek-chat`）
2. **操作方向**：大模型建议的交易操作（如"买入"、"卖出"、"持有"等）
3. **股票信息**：股票名称和代码
4. **投资评级**：综合评级（如有）

## 📧 邮件主题格式

### 标准格式
```
[{模型名称}] {操作方向} {股票名称}({代码}) - {投资评级}
```

### 实际示例

#### 完整信息示例
```
[qwen3-max] 买入（轻仓博弈反弹） TCL科技(000100) - 强烈推荐
```

#### 无投资评级示例
```
[qwen3-max] 买入（轻仓博弈反弹） TCL科技(000100)
```

#### 最简示例
```
[deepseek-chat] 恺英网络(002517)
```

## 🔍 信息提取机制

### 1. 模型名称提取
- **来源**：从 `intraday_trading_config.json` 配置文件中读取
- **路径**：`api_config` → `{api_provider}` → `model`
- **示例**：
  ```json
  {
    "api_provider": "qwen",
    "api_config": {
      "qwen": {
        "model": "qwen3-max"  ← 提取此值
      }
    }
  }
  ```

### 2. 操作方向提取
- **来源**：从生成的Markdown分析报告中自动提取
- **支持格式**：
  1. `**操作方向：买入（轻仓博弈反弹）**`
  2. `| **操作方向** | ✅ 买入（轻仓做反弹） |`
  3. `操作方向：买入`
  4. `**交易建议：买入**`

- **清理逻辑**：
  - 自动移除Markdown粗体标记（`**`）
  - 自动移除表情符号（✅❌🟢🟡🔴📊）
  - 保留核心操作内容和说明

### 3. 投资评级提取
- **来源**：从Markdown报告的表格中提取
- **支持格式**：
  - `| **投资评级** | ✅ **强烈推荐（Strong Buy）** |`
  - `**投资评级** | ✅ **强烈推荐（Strong Buy）** |`

- **清理逻辑**：
  - 移除Markdown格式符号
  - 移除表情符号
  - 提取纯文本评级

## 💡 实现细节

### 新增函数

#### `extract_trading_action(md_file_path: str) -> str`
从Markdown文件中提取操作方向信息。

**特点**：
- 支持多种格式的正则匹配
- 自动清理格式符号
- 提取失败返回空字符串（不影响邮件发送）

**代码示例**：
```python
trading_action = extract_trading_action("path/to/report.md")
# 返回: "买入（轻仓博弈反弹）"
```

#### `extract_investment_rating(md_file_path: str) -> str`
从Markdown文件中提取投资评级信息（已有功能，未修改）。

### 邮件主题构建逻辑

```python
# 1. 获取模型名称
api_provider = self.config.get('api_provider', 'qwen')
model_name = self.config['api_config'][api_provider]['model']

# 2. 提取操作方向和投资评级
trading_action = extract_trading_action(md_filepath)
investment_rating = extract_investment_rating(md_filepath)

# 3. 构建邮件主题
subject_parts = [f"[{model_name}]"]  # 模型名称（必有）

if trading_action:
    subject_parts.append(trading_action)  # 操作方向（可选）

subject_parts.append(f"{stock_name}({stock_code})")  # 股票信息（必有）

if investment_rating:
    subject_parts.append(f"- {investment_rating}")  # 投资评级（可选）

email_subject = " ".join(subject_parts)
```

## 🎨 主题展示效果对比

### 修改前
```
股票 TCL科技(000100) 日内分析报告
```
❌ 无法直观看到分析结论

### 修改后
```
[qwen3-max] 买入（轻仓博弈反弹） TCL科技(000100)
```
✅ 一目了然：使用qwen3-max模型，建议买入（轻仓）

## 📊 使用场景

### 场景1：批量分析多只股票
分析10只股票后，邮箱收件箱显示：
```
[qwen3-max] 买入（轻仓） TCL科技(000100)
[qwen3-max] 持有观望 平安银行(000001)
[qwen3-max] 卖出止损 恺英网络(002517)
...
```
👍 **优势**：无需打开邮件即可快速筛选关注的股票

### 场景2：对比不同模型的建议
使用不同模型分析同一股票：
```
[qwen3-max] 买入（轻仓） TCL科技(000100)
[deepseek-chat] 持有观望 TCL科技(000100)
```
👍 **优势**：可以对比不同模型的分析差异

### 场景3：邮件自动分类
通过邮件客户端的规则，可以自动分类：
- 所有"买入"相关的邮件标记为重要
- 所有"卖出"相关的邮件发送通知
- 按模型名称分类存档

## 🔧 技术优化

### 容错机制
- **提取失败不影响邮件发送**：如果无法提取操作方向或评级，仍会发送邮件，只是主题中不包含这些信息
- **多格式兼容**：支持多种Markdown格式的操作方向表达
- **自动清理**：自动移除各种格式符号，保证主题简洁

### 性能优化
- 使用正则表达式快速匹配
- 只在需要发送邮件时才执行提取操作
- 提取失败不重试（避免不必要的开销）

## 🎯 测试验证

### 测试结果
使用实际分析报告测试：
```bash
测试文件: intraday_output/000100_TCL科技_analysis_20251024_222856.md
✅ 操作方向: 买入（轻仓博弈反弹）
✅ 投资评级: (未找到)

📧 邮件主题预览:
   [qwen3-max] 买入（轻仓博弈反弹） TCL科技(000100)
```

## 📝 注意事项

1. **操作方向提取依赖于报告格式**
   - 如果大模型返回的报告格式发生变化，可能需要更新正则表达式
   - 建议在提示词中明确要求使用标准格式输出操作方向

2. **邮件主题长度**
   - 操作方向如果过长（如包含详细说明），邮件主题可能较长
   - 不会影响功能，但显示时可能被截断

3. **模型名称**
   - 确保在 `intraday_trading_config.json` 中正确配置了模型名称
   - 模型名称会直接显示在主题中

## 🚀 后续优化建议

1. **支持自定义主题模板**
   - 允许用户在配置文件中自定义邮件主题格式
   - 例如：`"{model} | {action} | {stock}"`

2. **操作方向关键词提取**
   - 可以进一步简化操作方向，只保留核心关键词（买入/卖出/持有）
   - 例如："买入（轻仓博弈反弹）" → "买入"

3. **增加价格变动信息**
   - 在主题中可以包含涨跌幅信息
   - 例如：`[qwen3-max] 买入 TCL科技(000100) -0.24%`

4. **彩色标签支持**
   - 根据操作方向使用不同的表情符号
   - 买入📈 / 卖出📉 / 持有⏸️

## 📞 反馈与支持

如果在使用过程中遇到问题：
1. 检查Markdown报告格式是否符合预期
2. 查看终端输出的提取结果日志
3. 确认配置文件中的模型名称设置

---

**版本**: v1.1  
**更新日期**: 2025-10-25  
**作者**: AI Assistant

